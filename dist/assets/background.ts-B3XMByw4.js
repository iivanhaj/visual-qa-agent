import{c as g,A as d}from"./openai-CypmmGs-.js";import"./index-DU3xAm2I.js";console.log("‚úÖ Visual QA Agent: Enhanced Background Service Worker Loaded");console.log("‚è∞ Timestamp:",new Date().toISOString());chrome.action.onClicked.addListener(o=>{console.log("üîò Extension icon clicked, opening sidebar..."),chrome.sidePanel.open({windowId:o.windowId})});chrome.runtime.onMessage.addListener((o,r,e)=>{if(o.type==="START_AGENT")return m(o.goal,e),!0;if(o.type==="RUN_BUG_DETECTION")return u(o.tests,e),!0;if(o.type==="CAPTURE_VIEWPORT")return chrome.tabs.query({active:!0,currentWindow:!0},t=>{var n;((n=t[0])==null?void 0:n.windowId)!==void 0?chrome.tabs.captureVisibleTab(t[0].windowId,{format:"jpeg",quality:85},a=>{chrome.runtime.lastError?(console.error("Screenshot error:",chrome.runtime.lastError),e({success:!1,error:chrome.runtime.lastError.message})):e({success:!0,screenshot:a})}):e({success:!1,error:"No active window"})}),!0});async function u(o,r){console.log("üîç [Background] Starting bug detection for tests:",o);try{const[e]=await chrome.tabs.query({active:!0,currentWindow:!0});if(!e.id)throw new Error("No active tab found");console.log("üì§ [Background] Sending message to content script on tab:",e.id);const t=await chrome.tabs.sendMessage(e.id,{type:"RUN_BUG_DETECTION",tests:o});console.log("üì• [Background] Received response from content script:",t),r(t)}catch(e){console.error("‚ùå [Background] Bug detection error:",e),r({success:!1,error:e.message||String(e)})}}async function m(o,r){console.log("üéØ [Background] Starting agent with goal:",o);try{const[e]=await chrome.tabs.query({active:!0,currentWindow:!0});if(!e.id)throw new Error("No active tab found");console.log("üì∏ [Background] Requesting full page screenshots...");const t=await chrome.tabs.sendMessage(e.id,{type:"CAPTURE_FULL_PAGE"});if(!t.success)throw new Error("Failed to capture screenshots: "+t.error);console.log(`‚úÖ [Background] Captured ${t.screenshots.length} screenshots`),console.log(`üìè [Background] Page height: ${t.metadata.totalHeight}px`),console.log("üåê [Background] Fetching DOM from content script...");let n;try{n=await chrome.tabs.sendMessage(e.id,{type:"GET_DOM"})}catch(s){throw console.warn("Content script unreachable:",s),new Error("Could not connect to page. Refresh the page and try again.")}console.log("ü§ñ [Background] Calling OpenAI with full page context...");const a=await g(),l=t.screenshots.map(s=>({type:"image_url",image_url:{url:s}})),i=(await a.chat.completions.create({model:"gpt-4-turbo",messages:[{role:"system",content:d},{role:"user",content:[{type:"text",text:`Goal: ${o}

I'm providing ${t.screenshots.length} screenshots of the entire page (scrolled from top to bottom).

Page Context (Simplified):
${n.dom}`},...l]}],max_tokens:500,response_format:{type:"json_object"}})).choices[0].message.content;console.log("üé¨ [Background] Agent decided:",i);let c;try{c=JSON.parse(i||"{}")}catch{throw console.error("Failed to parse JSON:",i),new Error("Invalid response from Agent")}c.type!=="FINISH"&&await chrome.tabs.sendMessage(e.id,{type:"EXECUTE_ACTION",action:c}),r({success:!0,action:c})}catch(e){console.error("‚ùå [Background] Agent Error:",e),r({success:!1,error:e.message||String(e)})}}
